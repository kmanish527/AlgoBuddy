const l="http://localhost:8080/api/buddy/process";let c=null;document.addEventListener("DOMContentLoaded",()=>{w(),document.getElementById("hint").addEventListener("click",f),document.getElementById("code").addEventListener("click",y),document.getElementById("procedure").addEventListener("click",v),T(),E()});function f(){p(),h()}async function h(){try{d();const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),n=await m(e.id),t=await C(e.id);if(!n){a("Could not find a LeetCode problem on this page.");return}const r=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({problem:n,currentSolution:t,operation:"Hint"})});if(!r.ok)throw new Error("Backend server error");const i=await r.text();a(i)}catch(e){console.error("Error in fetchAndShowHint:",e),a("Error fetching hint.")}}function w(){chrome.storage.session.get(["triggerHintOnLoad"],e=>{e.triggerHintOnLoad&&(chrome.storage.session.remove("triggerHintOnLoad"),h())})}async function y(){try{d();const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),n=await m(e.id),t=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({problem:n,currentSolution:"",operation:"Code"})});if(!t.ok)throw new Error("Backend server error");const r=await t.text();a(r)}catch(e){console.error("Error in getCode:",e),a("Error fetching code.")}}async function v(){try{d();const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),n=await m(e.id),t=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({problem:n,currentSolution:"",operation:"Procedure"})});if(!t.ok)throw new Error("Backend server error");const r=await t.text();a(r)}catch(e){console.error("Error in getProcedure:",e),a("Error fetching procedure.")}}function T(){document.querySelectorAll(".timer-btn").forEach(n=>{n.addEventListener("click",t=>{const r=parseInt(t.target.dataset.time,10)/60;chrome.storage.local.set({hintTimerDuration:r},()=>{u(r),chrome.runtime.sendMessage({message:"leetCodeProblemLoaded"}),g(r*60*1e3)})})})}function E(){chrome.storage.local.get(["hintTimerDuration"],e=>{e.hintTimerDuration&&(u(e.hintTimerDuration),chrome.runtime.sendMessage({message:"getTimerStatus"},n=>{n&&n.remainingTime>0&&g(n.remainingTime)}))})}function g(e){c&&clearInterval(c);const n=document.getElementById("timer-status");let t=Math.floor(e/1e3);const r=()=>{const i=Math.floor(t/60),o=t%60;n.innerHTML=`Hint in ${i}:${o<10?"0":""}${o} <span class="cancel-timer">Cancel</span>`,n.querySelector(".cancel-timer").addEventListener("click",p)};if(t<=0){n.innerHTML="";return}r(),c=setInterval(()=>{t--,t>0?r():(clearInterval(c),n.innerHTML="")},1e3)}function p(){c&&clearInterval(c),c=null,document.getElementById("timer-status").innerHTML="",chrome.runtime.sendMessage({message:"cancelAlarm"}),chrome.storage.local.set({hintTimerDuration:0},()=>{u(0)})}function d(){a('<div class="loader"></div>')}function a(e){const n=document.getElementById("results");if(e.includes('class="loader"')){n.innerHTML=e;return}const t=e.toLowerCase(),r=t.includes("intuition")||t.includes("approach")||t.includes("edge cases")||t.includes("algorithm")||t.includes("complexity"),i=e.startsWith("```java");if(r){const o=marked.parse(e);n.innerHTML=`<div class="result-content">${o}</div>`,Prism.highlightAll()}else if(i){const o=e.replace(/^```java\n|```$/g,"").trim();n.innerHTML=`
      <div class="code-container">
        <div class="code-header">
          <span class="language-label">Java</span>
          <button class="copy-btn">
            <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
            <span>Copy</span>
          </button>
        </div>
        <pre><code class="language-java">${o.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</code></pre>
      </div>
    `;const s=n.querySelector(".copy-btn");s.addEventListener("click",()=>{navigator.clipboard.writeText(o).then(()=>{s.querySelector("span").textContent="Copied!",setTimeout(()=>{s.querySelector("span").textContent="Copy"},2e3)})}),Prism.highlightAll()}}function u(e){const n=e*60;document.querySelectorAll(".timer-btn").forEach(t=>{t.classList.toggle("active",parseInt(t.dataset.time,10)===n)})}async function m(e){const[{result:n}]=await chrome.scripting.executeScript({target:{tabId:e},func:()=>{const t=document.querySelector('meta[name="description"]');return t?t.content:null}});return n}async function C(e){const[{result:n}]=await chrome.scripting.executeScript({target:{tabId:e},func:()=>{const t=document.querySelector(".view-lines");if(!t)return"";const r=t.querySelectorAll(".view-line");let i="";return r.forEach(o=>{i+=o.innerText+`
`}),i.trim()}});return n}
